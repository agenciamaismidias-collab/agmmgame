<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Pautas</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .crown-icon { filter: drop-shadow(0px 2px 4px rgba(234, 179, 8, 0.5)); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged, signInAnonymously, setPersistence, inMemoryPersistence
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, addDoc, getDoc, 
            query, onSnapshot, where, serverTimestamp, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { 
            Settings, Users, Briefcase, ListTodo, ClipboardList, BarChart3, User, LogOut, 
            ArrowLeft, Plus, Check, Building, Trash2, Pencil, X, Calendar as CalendarIcon, 
            Flag, AlertTriangle, Lock, ShieldCheck, UserCircle, UserPlus, Eye, Crown, Star, Clock, UserCheck
        } from "https://esm.sh/lucide-react@0.292.0";

        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURAÇÃO ---
        const appId = 'sistema-avaliacao-pautas';
        const SUPER_ADMINS = ['sabrinacruz.mkt@gmail.com'];
        
        const firebaseConfig = {
            apiKey: "AIzaSyBCDi_zta4H3-WARJnOtmWneWe-9yGYJ2U",
            authDomain: "agmm-gamificacao.firebaseapp.com",
            projectId: "agmm-gamificacao",
            storageBucket: "agmm-gamificacao.firebasestorage.app",
            messagingSenderId: "833753514640",
            appId: "1:833753514640:web:70b570fd73f470d3468e15",
            measurementId: "G-Y8LCBFR78Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
        const secondaryAuth = getAuth(secondaryApp);

        const getPublicCollectionPath = (name) => `artifacts/${appId}/public/data/${name}`;
        const formatDate = (d) => {
            if(!d) return 'N/A';
            if(d.toDate) return d.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric'});
            try { const [y,m,d] = d.split('-'); return `${d}/${m}/${y}`; } catch { return 'N/A'; }
        };

        // --- COMPONENTES UI ---
        const Card = ({ children, title, icon: Icon, className = "" }) => (
            <div className={`bg-white p-6 rounded-xl shadow-sm border border-gray-200 ${className}`}>
                {title && <h2 className="flex items-center text-lg font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2">{Icon && <Icon className="w-5 h-5 mr-2 text-indigo-600" />}{title}</h2>}
                {children}
            </div>
        );

        const Button = ({ children, onClick, disabled, icon: Icon, type = "primary", size = "md", className = "" }) => {
            let base = "flex items-center justify-center font-medium rounded-lg transition-all duration-200 disabled:opacity-50 ";
            if (size === 'sm') base += "px-3 py-1.5 text-xs "; else if (size === 'icon') base += "p-2 "; else base += "px-4 py-2 text-sm ";
            const colors = {
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
                success: "bg-green-600 text-white hover:bg-green-700 shadow-sm",
                ghost: "text-gray-500 hover:bg-gray-100 border-transparent",
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${colors[type] || colors.primary} ${className}`}>{Icon && <Icon className={`w-4 h-4 ${children?'mr-2':''}`}/>}{children}</button>;
        };

        const Input = ({ label, type="text", value, onChange, required, className="" }) => (
            <div className="mb-4">
                {label && <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{label} {required && <span className="text-red-500">*</span>}</label>}
                <input type={type} value={value} onChange={onChange} required={required} className={`w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${className}`} />
            </div>
        );

        const MonthSelector = ({ selectedMonth, setSelectedMonth }) => (
            <div className="flex items-center space-x-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                <label htmlFor="month-select" className="text-xs font-medium text-gray-500 pl-2">Mês:</label>
                <input type="month" id="month-select" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="text-sm border-none focus:ring-0 bg-transparent text-gray-700 font-medium cursor-pointer outline-none" />
            </div>
        );

        // --- LOGIN ---
        const LoginScreen = ({ onRoleSelect }) => {
            const [step, setStep] = useState(1);
            const [role, setRole] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [name, setName] = useState('');

            const handleRoleClick = (selectedRole) => {
                setRole(selectedRole);
                onRoleSelect(selectedRole);
                setStep(2);
                setError('');
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true); 
                setError('');
                try {
                    if (isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        const isSuper = SUPER_ADMINS.includes(email);
                        await setDoc(doc(db, `artifacts/${appId}/public/data/funcionarios`, cred.user.uid), {
                            id: cred.user.uid, 
                            nome: name, 
                            email: email, 
                            isAdmin: isSuper, 
                            cargoId: '', 
                            clienteIds: [], 
                            approved: isSuper, // SUPER ADMIN nasce aprovado
                            timestamp: serverTimestamp()
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/email-already-in-use') msg = "E-mail já cadastrado.";
                    if (err.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                    if (err.code === 'auth/invalid-credential') msg = "E-mail ou senha incorretos.";
                    setError(msg);
                    setLoading(false);
                }
            };

            if(step === 1) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                    <div className="text-center mb-10"><h1 className="text-4xl font-bold text-indigo-900 mb-2 tracking-tight">Sistema de Pautas</h1><p className="text-gray-500">Selecione seu perfil de acesso</p></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl w-full mb-8">
                        <div onClick={()=>handleRoleClick('admin')} className="bg-white p-8 rounded-2xl shadow-sm border cursor-pointer hover:border-indigo-500 transition group text-center hover:shadow-md"><div className="bg-indigo-50 p-4 rounded-full mb-4 mx-auto w-16 group-hover:bg-indigo-100 transition"><ShieldCheck className="w-8 h-8 text-indigo-600"/></div><h2 className="text-xl font-bold text-gray-800">Administrador</h2><p className="text-sm text-gray-500 mt-2">Gestão e Validação</p></div>
                        <div onClick={()=>handleRoleClick('employee')} className="bg-white p-8 rounded-2xl shadow-sm border cursor-pointer hover:border-green-500 transition group text-center hover:shadow-md"><div className="bg-green-50 p-4 rounded-full mb-4 mx-auto w-16 group-hover:bg-green-100 transition"><UserCircle className="w-8 h-8 text-green-600"/></div><h2 className="text-xl font-bold text-gray-800">Funcionário</h2><p className="text-sm text-gray-500 mt-2">Produção e Lançamentos</p></div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <Card className="w-full max-w-md relative border-0 shadow-xl">
                        <button onClick={()=>{setStep(1); setIsRegistering(false); setError('')}} className="absolute top-6 left-6 text-gray-400 hover:text-gray-600 flex items-center text-xs uppercase font-bold"><ArrowLeft className="w-3 h-3 mr-1"/> Voltar</button>
                        <div className="text-center mb-8 mt-4"><h1 className="text-2xl font-bold text-gray-800">Login {role === 'admin' ? 'Admin' : ''}</h1><p className="text-gray-500 text-sm">Insira suas credenciais</p></div>
                        <form onSubmit={handleAuth}>
                            {isRegistering && <Input label="Nome" value={name} onChange={e=>setName(e.target.value)} required />}
                            <Input label="E-mail" type="email" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <Input label="Senha" type="password" value={password} onChange={e=>setPassword(e.target.value)} required />
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center border border-red-100">{error}</div>}
                            <Button className="w-full h-10" disabled={loading}>{loading ? 'Processando...' : (isRegistering ? 'Criar Conta' : 'Entrar')}</Button>
                        </form>
                        <div className="text-center mt-4 pt-4 border-t border-gray-100">
                            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-xs text-gray-500 hover:text-indigo-600 font-medium">{isRegistering ? 'Já possui conta? Faça Login' : 'Não tem acesso? Cadastre-se aqui'}</button>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- ADMIN COMPONENTS ---
        const RankingChart = ({ data }) => {
            const maxScore = Math.max(...data.map(f => f.score || 0), 1); 
            return (
                <div className="space-y-4">
                    {data.map((f, index) => {
                        const isFirst = index === 0;
                        return (
                            <div key={f.id} className={`relative p-3 rounded-xl border transition-all ${isFirst ? 'bg-yellow-50 border-yellow-200 shadow-sm' : 'bg-white border-gray-100 hover:shadow-sm'}`}>
                                <div className="flex justify-between items-center mb-2 z-10 relative">
                                    <div className="flex items-center gap-2">
                                        {isFirst ? <div className="w-6 h-6 flex items-center justify-center bg-yellow-100 rounded-full text-yellow-600 crown-icon"><Crown className="w-4 h-4 fill-current" /></div> : <div className="w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 text-xs font-bold">{index + 1}</div>}
                                        <span className={`font-semibold ${isFirst ? 'text-yellow-800' : 'text-gray-700'}`}>{f.nome}</span>
                                    </div>
                                    <span className={`font-bold text-sm ${isFirst ? 'text-yellow-700' : 'text-indigo-600'}`}>{f.score}%</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div className={`h-full rounded-full transition-all duration-500 ${isFirst ? 'bg-yellow-400' : 'bg-indigo-500'}`} style={{ width: f.score > 0 ? `${f.score}%` : '2%' }}></div></div>
                                {f.totalPenalidades > 0 && <div className="mt-1 flex justify-end"><span className="text-[10px] text-red-500 bg-red-50 px-1.5 py-0.5 rounded flex items-center"><Flag className="w-3 h-3 mr-1" /> -{f.totalPenalidades} pts</span></div>}
                            </div>
                        );
                    })}
                    {data.length === 0 && <p className="text-center text-gray-400 text-sm py-4">Sem dados de ranking.</p>}
                </div>
            );
        };

        const CalendarView = ({ db, userId, funcionarios, lancamentos, bandeiras, selectedMonth }) => {
            const [selectedFuncionarioId, setSelectedFuncionarioId] = useState('');
            const [flagModalOpen, setFlagModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [flagReason, setFlagReason] = useState('');
            const [loadingFlag, setLoadingFlag] = useState(false);

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
            const year = parseInt(selectedMonth.split('-')[0]);
            const month = parseInt(selectedMonth.split('-')[1]) - 1;
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const blanksArray = Array.from({ length: firstDay }, (_, i) => i);

            const funcionarioLancamentos = useMemo(() => selectedFuncionarioId ? lancamentos.filter(l => l.funcionarioId === selectedFuncionarioId) : [], [lancamentos, selectedFuncionarioId]);
            const funcionarioBandeiras = useMemo(() => selectedFuncionarioId ? bandeiras.filter(b => b.funcionarioId === selectedFuncionarioId) : [], [bandeiras, selectedFuncionarioId]);

            const handleDayClick = (day) => {
                if (!selectedFuncionarioId) return;
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const existingFlag = funcionarioBandeiras.find(b => b.data === dateStr);
                if (existingFlag) {
                    if (window.confirm("Remover bandeira?")) deleteDoc(doc(db, getPublicCollectionPath('bandeiras'), existingFlag.id));
                } else {
                    setSelectedDate(dateStr);
                    setFlagModalOpen(true);
                }
            };

            const handleAddFlag = async () => {
                if (!db || !selectedFuncionarioId || !selectedDate) return;
                setLoadingFlag(true);
                try {
                    await addDoc(collection(db, getPublicCollectionPath('bandeiras')), {
                        funcionarioId: selectedFuncionarioId, data: selectedDate, motivo: flagReason || 'Penalidade Administrativa', criadoPor: userId, timestamp: serverTimestamp()
                    });
                    setFlagModalOpen(false); setFlagReason('');
                } catch (error) { console.error("Erro:", error); } finally { setLoadingFlag(false); }
            };

            return (
                <div className="space-y-6">
                    <Card title="Calendário e Penalidades" icon={CalendarIcon}>
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-600 mb-2">Selecione o Funcionário</label>
                            <select value={selectedFuncionarioId} onChange={(e) => setSelectedFuncionarioId(e.target.value)} className="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Selecione --</option>
                                {funcionarios.map(f => <option key={f.id} value={f.id}>{f.nome}</option>)}
                            </select>
                        </div>
                        {selectedFuncionarioId && (
                            <div className="border rounded-lg overflow-hidden bg-white shadow-sm">
                                <div className="grid grid-cols-7 bg-gray-50 border-b text-center py-2 text-xs font-semibold text-gray-500 uppercase">{['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => <div key={d}>{d}</div>)}</div>
                                <div className="grid grid-cols-7 bg-white">
                                    {blanksArray.map(b => <div key={`blank-${b}`} className="h-20 border-b border-r bg-gray-50/30"></div>)}
                                    {daysArray.map(day => {
                                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                        const hasLancamento = funcionarioLancamentos.some(l => l.dataConclusao === dateStr);
                                        const hasFlag = funcionarioBandeiras.find(b => b.data === dateStr);
                                        return (
                                            <div key={day} onClick={() => handleDayClick(day)} className="h-20 border-b border-r p-1 cursor-pointer hover:bg-indigo-50 group">
                                                <span className={`text-sm font-medium ${hasFlag ? 'text-red-600' : 'text-gray-700'}`}>{day}</span>
                                                <div className="flex flex-col gap-1 mt-1">
                                                    {hasLancamento && <div className="flex items-center text-[10px] text-green-700 bg-green-50 border border-green-100 px-1 rounded"><Check className="w-3 h-3 mr-1" /> Entregue</div>}
                                                    {hasFlag && <div className="flex items-center text-[10px] text-red-700 bg-red-50 border border-red-100 px-1 rounded"><Flag className="w-3 h-3 mr-1" /> Penalidade</div>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </Card>
                    {flagModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
                                <h3 className="text-lg font-bold text-red-600 mb-4 flex items-center"><AlertTriangle className="w-5 h-5 mr-2"/> Penalidade</h3>
                                <Input label="Motivo da Bandeira" value={flagReason} onChange={(e) => setFlagReason(e.target.value)} />
                                <div className="flex justify-end space-x-2 mt-4">
                                    <Button type="secondary" onClick={() => setFlagModalOpen(false)}>Cancelar</Button>
                                    <Button type="danger" onClick={handleAddFlag} disabled={loadingFlag}>Aplicar (-1 pt)</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- VALIDAÇÃO DE LANÇAMENTO ---
        const ValidacaoLancamento = ({ db, userId, lancamentos, atividadesBase, funcionarios }) => {
            const pendentes = useMemo(() => lancamentos.filter(l => l.status === 'Pendente'), [lancamentos]);
            const [scoreMap, setScoreMap] = useState({});
            const [loadingMap, setLoadingMap] = useState({});

            useEffect(() => {
                const map = {};
                pendentes.forEach(l => { 
                    if (scoreMap[l.id] === undefined) {
                        const max = atividadesBase.find(a => a.id === l.atividadeBaseId)?.pontuacaoMaxima || 1;
                        map[l.id] = max; 
                    }
                });
                if (Object.keys(map).length > 0) {
                    setScoreMap(prev => ({ ...prev, ...map }));
                }
            }, [pendentes, atividadesBase]); 

            const handleVal = async (l) => {
                setLoadingMap(p => ({...p, [l.id]: true}));
                try {
                    await setDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id), { 
                        status: 'Validado', 
                        pontuacaoAtribuida: Number(scoreMap[l.id]), 
                        dataValidacao: serverTimestamp(), 
                        validadorId: userId 
                    }, {merge:true});
                } catch(e){ console.error(e); } finally { setLoadingMap(p => ({...p, [l.id]: false})); }
            };

            if (pendentes.length === 0) return <div className="text-center p-8 bg-white rounded-xl border border-gray-200 text-gray-500">Tudo limpo! Nenhum lançamento pendente.</div>;

            return (
                <div className="space-y-3">
                    {pendentes.map(l => {
                        const atv = atividadesBase.find(a => a.id === l.atividadeBaseId) || {};
                        const func = funcionarios.find(f => f.id === l.funcionarioId) || {};
                        const maxScore = Number(atv.pontuacaoMaxima) || 1;
                        
                        return (
                            <div key={l.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex-1">
                                    <p className="font-bold text-indigo-700 text-base">{atv.nome}</p>
                                    <p className="text-sm text-gray-600 mt-1">Funcionário: <span className="font-semibold">{func.nome}</span></p>
                                    <div className="flex items-center gap-3 mt-1 text-xs text-gray-400">
                                        <span className="flex items-center"><CalendarIcon className="w-3 h-3 mr-1"/> {formatDate(l.dataConclusao)}</span>
                                        {l.descricao && <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[200px]">{l.descricao}</span>}
                                    </div>
                                </div>
                                <div className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg">
                                    <span className="text-xs text-gray-500 font-bold uppercase mr-1">Nota:</span>
                                    <input 
                                        type="number" 
                                        max={maxScore} 
                                        min="0"
                                        value={scoreMap[l.id] !== undefined ? scoreMap[l.id] : maxScore} 
                                        onChange={e => setScoreMap(p => ({...p, [l.id]: e.target.value}))} 
                                        className="w-12 text-center border rounded py-1 text-sm font-bold text-indigo-700 focus:ring-indigo-500 outline-none"
                                    />
                                    <span className="text-xs text-gray-400">/ {maxScore}</span>
                                    <Button size="sm" onClick={()=>handleVal(l)} disabled={loadingMap[l.id]} icon={Check}>Validar</Button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- ATIVIDADES BASE FORM ---
        const AtividadeBaseForm = ({ db, userId, cargos, atividadesBase }) => {
            const [nome, setNome] = useState(''); 
            const [cargoId, setCargoId] = useState(''); 
            const [peso, setPeso] = useState('');
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!nome || !cargoId || !peso) return;
                const data = { 
                    nome, 
                    cargoId, 
                    pontuacaoMaxima: Number(peso), 
                    criadoPor: userId,
                    timestamp: serverTimestamp()
                };
                try {
                    if(editingId) await setDoc(doc(db, getPublicCollectionPath('atividadesBase'), editingId), data, {merge:true});
                    else await addDoc(collection(db, getPublicCollectionPath('atividadesBase')), data);
                    setNome(''); setCargoId(''); setPeso(''); setEditingId(null);
                } catch(e){ console.error(e); }
            };

            const handleEdit = (item) => {
                setNome(item.nome); setCargoId(item.cargoId); setPeso(item.pontuacaoMaxima); setEditingId(item.id);
            };

            const handleDelete = async (id) => {
                if(confirm('Excluir atividade?')) deleteDoc(doc(db, getPublicCollectionPath('atividadesBase'), id));
            };

            return (
                <Card title="Atividades Base" icon={ListTodo}>
                    <form onSubmit={handleSubmit} className="mb-6 space-y-3 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <Input label="Nome da Atividade" value={nome} onChange={e=>setNome(e.target.value)} placeholder="Ex: Criar Post" required className="bg-white"/>
                        <div className="flex gap-2">
                            <div className="w-2/3">
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Cargo</label>
                                <select value={cargoId} onChange={e=>setCargoId(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Selecione...</option>
                                    {cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                </select>
                            </div>
                            <div className="w-1/3">
                                <Input type="number" label="Pontuação" value={peso} onChange={e=>setPeso(e.target.value)} placeholder="Pts" required className="bg-white" />
                            </div>
                        </div>
                        <div className="flex justify-end gap-2">
                            {editingId && <Button type="secondary" size="sm" onClick={() => { setEditingId(null); setNome(''); setCargoId(''); setPeso(''); }}>Cancelar</Button>}
                            <Button size="sm">{editingId ? 'Salvar' : 'Adicionar'}</Button>
                        </div>
                    </form>
                    <ul className="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                        {atividadesBase.map(a => (
                            <li key={a.id} className="flex justify-between items-center p-2 bg-white border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors group">
                                <div>
                                    <span className="text-sm font-medium text-gray-700 block">{a.nome}</span>
                                    <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">Valendo: {a.pontuacaoMaxima} pts</span>
                                </div>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Button type="ghost" size="icon" onClick={()=>handleEdit(a)}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                    <Button type="ghost" size="icon" onClick={()=>handleDelete(a.id)}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                </div>
                            </li>
                        ))}
                    </ul>
                </Card>
            );
        };

        const AdminView = ({ db, userId, cargos, funcionarios, atividades, lancamentos, clientes, bandeiras, logout, month, setMonth }) => {
            const [tab, setTab] = useState('dashboard');
            const [showUserModal, setShowUserModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            
            const dashData = useMemo(() => {
                const d = funcionarios.map(f => ({ ...f, pts: 0, max: 0, count: 0, flags: 0, score: 0 }));
                lancamentos.filter(l=>l.status==='Validado').forEach(l => {
                    const idx = d.findIndex(x=>x.id===l.funcionarioId);
                    if(idx > -1) {
                        const atv = atividades.find(a=>a.id===l.atividadeBaseId);
                        d[idx].pts += Number(l.pontuacaoAtribuida||0);
                        d[idx].max += (atv?.pontuacaoMaxima||1);
                        d[idx].count++;
                    }
                });
                bandeiras.forEach(b => {
                    const idx = d.findIndex(x=>x.id===b.funcionarioId);
                    if(idx > -1) { d[idx].flags++; d[idx].pts -= 1; }
                });
                return d.map(x => ({ ...x, pts: Math.max(0, x.pts), score: x.max > 0 ? ((Math.max(0, x.pts)/x.max)*100).toFixed(0) : 0 })).sort((a,b)=>b.score-a.score);
            }, [funcionarios, lancamentos, bandeiras, atividades]);

            const handleCreateOrUpdateUser = async (data) => {
                try {
                    // IMPORTANTE: Configura persistência da App secundária para não afetar o login atual
                    await setPersistence(secondaryAuth, inMemoryPersistence);

                    if (data.id) {
                        await setDoc(doc(db, getPublicCollectionPath('funcionarios'), data.id), {
                            nome: data.nome, cargoId: data.cargoId, clienteIds: data.cliIds, isAdmin: data.isAdmin, approved: true // Ao editar, aprova automaticamente
                        }, { merge: true });
                        alert("Usuário atualizado e aprovado!");
                    } else {
                        const cred = await createUserWithEmailAndPassword(secondaryAuth, data.email, data.password);
                        await setDoc(doc(db, getPublicCollectionPath('funcionarios'), cred.user.uid), {
                            id: cred.user.uid, nome: data.nome, email: data.email, cargoId: data.cargoId, clienteIds: data.cliIds, isAdmin: data.isAdmin, approved: true, criadoPor: userId, timestamp: serverTimestamp()
                        });
                        await signOut(secondaryAuth);
                        alert("Usuário criado com sucesso!");
                    }
                    setShowUserModal(false);
                    setEditingUser(null);
                } catch(e) { 
                    let msg = e.message;
                    if (e.code === 'auth/email-already-in-use') msg = "Este e-mail já está em uso.";
                    alert("Erro: " + msg); 
                }
            };

            const handleAdd = async (col, data) => addDoc(collection(db, getPublicCollectionPath(col)), { ...data, criadoPor: userId, timestamp: serverTimestamp() });
            const handleEdit = async (col, id, data) => setDoc(doc(db, getPublicCollectionPath(col), id), data, { merge: true });
            const handleDel = async (col, id) => { if(confirm('Excluir?')) deleteDoc(doc(db, getPublicCollectionPath(col), id)); };
            const handleVal = async (l, score) => setDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id), { status: 'Validado', pontuacaoAtribuida: score, validadorId: userId }, {merge:true});

            // Filtra usuários pendentes
            const pendingUsers = useMemo(() => funcionarios.filter(f => !f.approved && !f.isAdmin), [funcionarios]);

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b"><h1 className="text-3xl font-bold text-gray-800 flex items-center"><Settings className="mr-3 text-indigo-600"/> Admin</h1><div className="flex gap-4"><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border rounded p-2"/><Button onClick={logout} type="secondary" icon={LogOut}>Sair</Button></div></header>
                    <div className="flex gap-2 mb-8 overflow-x-auto pb-2">{[{id:'dashboard',label:'Dashboard',icon:BarChart3}, {id:'calendario',label:'Calendário',icon:CalendarIcon}, {id:'validacao',label:'Validação',icon:ClipboardList},{id:'cadastros',label:'Cadastros',icon:Briefcase}].map(t=><button key={t.id} onClick={()=>setTab(t.id)} className={`px-5 py-2 rounded-full text-sm flex items-center ${tab===t.id?'bg-indigo-600 text-white':'bg-white border'}`}><t.icon className="w-4 h-4 mr-2"/>{t.label}</button>)}</div>
                    
                    {tab==='dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card title="Ranking de Desempenho" className="md:col-span-1 h-full"><RankingChart data={dashData} /></Card>
                            <Card title="Detalhes Individuais" className="md:col-span-2"><div className="space-y-3 max-h-[60vh] overflow-y-auto">{dashData.map(f=><div key={f.id} className="p-4 border rounded bg-white hover:bg-gray-50 transition"><div className="flex justify-between font-bold mb-2"><span>{f.nome}</span><span className={f.score >= 90 ? "text-green-600" : "text-gray-600"}>{f.score}%</span></div><div className="text-sm text-gray-600 flex justify-between"><span>Pontos: {f.pts}/{f.max}</span>{f.flags>0 && <span className="text-red-600 font-semibold flex items-center"><Flag className="w-3 h-3 mr-1"/>{f.flags} Penalidade(s)</span>}</div></div>)}</div></Card>
                        </div>
                    )}

                    {tab==='calendario' && <CalendarView db={db} userId={userId} funcionarios={funcionarios} lancamentos={lancamentos} bandeiras={bandeiras} selectedMonth={month} />}

                    {tab==='validacao' && (
                        <Card title="Pendentes" icon={ClipboardList}>
                            <div className="space-y-4">
                                {lancamentos.filter(l=>l.status==='Pendente').map(l => {
                                    const atv = atividades.find(a=>a.id===l.atividadeBaseId);
                                    const func = funcionarios.find(f=>f.id===l.funcionarioId);
                                    return <div key={l.id} className="flex justify-between items-center p-3 border rounded"><div><p className="font-bold">{atv?.nome}</p><p className="text-sm">{func?.nome} - {formatDate(l.dataConclusao)}</p></div><div className="flex gap-2"><Button size="sm" onClick={()=>handleVal(l, atv?.pontuacaoMaxima)} icon={Check}>Validar (Max)</Button></div></div>
                                })}
                                {lancamentos.filter(l=>l.status==='Pendente').length === 0 && <p className="text-center text-gray-500">Nada pendente.</p>}
                            </div>
                        </Card>
                    )}

                    {tab==='cadastros' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* ÁREA DE APROVAÇÃO DE PENDENTES */}
                            {pendingUsers.length > 0 && (
                                <div className="col-span-1 md:col-span-2">
                                    <Card title="Solicitações de Acesso" icon={UserPlus} className="bg-yellow-50 border-yellow-200">
                                        <div className="space-y-2">
                                            {pendingUsers.map(f => (
                                                <div key={f.id} className="flex justify-between items-center p-3 bg-white rounded border border-yellow-200">
                                                    <div>
                                                        <span className="font-bold text-gray-800">{f.nome}</span>
                                                        <span className="text-sm text-gray-500 ml-2">({f.email})</span>
                                                        <span className="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold">Novo</span>
                                                    </div>
                                                    <Button size="sm" type="success" icon={Check} onClick={()=>{setEditingUser(f); setShowUserModal(true);}}>Aprovar e Configurar</Button>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </div>
                            )}

                            <SimpleForm title="Cargos" onAdd={n=>handleAdd('cargos',{nome:n})} onEdit={(id,n)=>handleEdit('cargos',id,{nome:n})} list={cargos} onDel={id=>handleDel('cargos',id)} />
                            <AtividadeBaseForm db={db} userId={userId} cargos={cargos} atividadesBase={atividades} />
                            <SimpleForm title="Clientes" onAdd={n=>handleAdd('clientes',{nome:n})} onEdit={(id,n)=>handleEdit('clientes',id,{nome:n})} list={clientes} onDel={id=>handleDel('clientes',id)} />
                            
                            <Card title="Funcionários Ativos" icon={Users}>
                                <div className="flex justify-between items-center mb-4"><span className="text-sm text-gray-500">Total: {funcionarios.length}</span><Button size="sm" icon={UserPlus} onClick={()=>{setEditingUser(null); setShowUserModal(true);}}>Novo</Button></div>
                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {funcionarios.map(f=>(
                                        <div key={f.id} className={`flex justify-between p-3 border rounded items-center text-sm bg-white ${!f.approved && !f.isAdmin ? 'border-l-4 border-l-yellow-400' : ''}`}>
                                            <div>
                                                <p className="font-semibold flex items-center">
                                                    {f.nome} 
                                                    {!f.approved && !f.isAdmin && <span className="ml-2 text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold">Pendente</span>}
                                                </p>
                                                <p className="text-xs text-gray-500">{f.email}</p>
                                            </div>
                                            <div className="flex gap-1">
                                                <Button size="icon" type="ghost" onClick={()=>{setEditingUser(f); setShowUserModal(true);}}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                                <Button size="icon" type="ghost" onClick={()=>handleDel('funcionarios', f.id)}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    )}
                    {showUserModal && <CreateUserModal onClose={()=>setShowUserModal(false)} onSave={handleCreateOrUpdateUser} cargos={cargos} clientes={clientes} initialData={editingUser} />}
                </div>
            );
        };

        const EmployeeView = ({ db, userId, user, cargos, atividades, lancamentos, clientes, bandeiras, logout, month, setMonth }) => {
            const [form, setForm] = useState({ atvId: '', cliId: '', date: '', desc: '' });
            const cargo = cargos.find(c=>c.id===user.cargoId);
            const myLancs = lancamentos.filter(l=>l.funcionarioId===userId);
            const myFlags = bandeiras.filter(b=>b.funcionarioId===userId);
            const myAtvs = atividades.filter(a=>a.cargoId===user.cargoId);
            const myClis = clientes.filter(c=>(user.clienteIds||[]).includes(c.id));

            const totalScore = useMemo(() => {
                const points = myLancs.filter(l => l.status === 'Validado').reduce((acc, curr) => acc + Number(curr.pontuacaoAtribuida || 0), 0);
                const penaltyPoints = myFlags.length;
                return Math.max(0, points - penaltyPoints);
            }, [myLancs, myFlags]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, getPublicCollectionPath('lancamentos')), {
                    funcionarioId: userId, atividadeBaseId: form.atvId, clienteId: form.cliId, dataConclusao: form.date, descricao: form.desc,
                    status: 'Pendente', pontuacaoAtribuida: 0, dataLancamento: serverTimestamp()
                });
                setForm({ atvId: '', cliId: '', date: '', desc: '' }); alert("Enviado!");
            };

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b"><h1 className="text-2xl font-bold text-indigo-800 flex items-center"><User className="mr-2"/> {user.nome}</h1><div className="flex gap-4"><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border rounded p-2"/><Button onClick={logout} type="secondary" icon={LogOut}>Sair</Button></div></header>
                    <div className="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <Card className="bg-indigo-50 border-indigo-100"><div className="flex justify-between items-center"><div><p className="text-sm font-bold text-gray-500 uppercase">Cargo</p><p className="text-xl text-indigo-700">{cargo?.nome || '-'}</p></div>{myFlags.length > 0 && <div className="bg-red-100 text-red-700 px-4 py-2 rounded border border-red-200 flex items-center"><AlertTriangle className="w-5 h-5 mr-2"/>{myFlags.length} Penalidades</div>}</div></Card>
                        <Card className="bg-green-50 border-green-100"><div className="flex items-center justify-between"><div><p className="text-sm font-bold text-gray-500 uppercase">Pontuação Acumulada</p><p className="text-3xl font-extrabold text-green-700">{totalScore} pts</p></div><div className="bg-green-200 p-3 rounded-full text-green-800"><Star className="w-8 h-8 fill-current" /></div></div></Card>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <Card title="Novo Lançamento" icon={Plus}>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-500">Cliente</label><select className="w-full border rounded p-2" value={form.cliId} onChange={e=>setForm({...form, cliId:e.target.value})}><option value="">Selecione...</option>{myClis.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">Atividade</label>
                                    <select className="w-full border rounded p-2" value={form.atvId} onChange={e=>setForm({...form, atvId:e.target.value})} required>
                                        <option value="">Selecione...</option>
                                        {/* MOSTRA APENAS O NOME, SEM PONTOS */}
                                        {myAtvs.map(a=><option key={a.id} value={a.id}>{a.nome}</option>)}
                                    </select>
                                </div>
                                <Input label="Data" type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required />
                                <Button className="w-full">Lançar</Button>
                            </form>
                        </Card>
                        <Card title="Histórico" icon={ClipboardList} className="md:col-span-2">
                            <div className="space-y-2 max-h-80 overflow-y-auto">{myLancs.map(l=><div key={l.id} className="p-3 border rounded bg-white flex justify-between items-center"><span>{atividades.find(a=>a.id===l.atividadeBaseId)?.nome} <span className="text-xs text-gray-400 ml-2">{formatDate(l.dataConclusao)}</span></span><span className={`text-xs px-2 py-1 rounded ${l.status==='Validado'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>{l.status}</span></div>)}</div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- HELPERS ---
        const SimpleForm = ({ title, list, onAdd, onEdit, onDel, extraFields, cargos }) => {
            const [val, setVal] = useState(''); const [cid, setCid] = useState(''); const [editingId, setEditingId] = useState(null);
            
            const handleSubmit = () => {
                if(val.trim()){
                    if(editingId) onEdit(editingId, val);
                    else onAdd(val);
                    setVal(''); setEditingId(null);
                }
            };

            return (
                <Card title={title} icon={ListTodo}>
                    <div className="flex gap-2 mb-4">
                        <Input value={val} onChange={e=>setVal(e.target.value)} placeholder={editingId ? "Editando..." : "Nome"} className="mb-0 flex-1"/>
                        {extraFields && <select className="border rounded px-2 w-1/3" value={cid} onChange={e=>setCid(e.target.value)}><option value="">Cargo</option>{cargos?.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select>}
                        <Button size="sm" onClick={handleSubmit}>{editingId ? 'Salvar' : '+'}</Button>
                        {editingId && <Button size="icon" type="ghost" onClick={()=>{setEditingId(null); setVal('')}}><X className="w-4 h-4"/></Button>}
                    </div>
                    <div className="space-y-1 max-h-40 overflow-y-auto">{list.map(i=><div key={i.id} className="flex justify-between p-2 border rounded text-sm bg-gray-50"><span>{i.nome}</span><div className="flex gap-1"><button onClick={()=>{setEditingId(i.id); setVal(i.nome);}} className="text-blue-600"><Pencil className="w-3 h-3"/></button><button onClick={()=>onDel(i.id)} className="text-red-500"><Trash2 className="w-3 h-3"/></button></div></div>)}</div>
                </Card>
            );
        };

        const CreateUserModal = ({ onClose, onSave, cargos, clientes, initialData }) => {
            const [d, setD] = useState(initialData ? 
                { id: initialData.id, nome: initialData.nome, email: initialData.email, cargoId: initialData.cargoId, cliIds: initialData.clienteIds || [], isAdmin: initialData.isAdmin } 
                : { nome:'', email:'', password:'', cargoId:'', cliIds:[], isAdmin: false }
            );
            
            const toggle = (id) => setD(p => ({...p, cliIds: p.cliIds.includes(id)?p.cliIds.filter(x=>x!==id):[...p.cliIds, id]}));
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-xl max-h-[90vh] overflow-y-auto">
                        <h2 className="text-lg font-bold mb-4">{initialData ? 'Editar & Aprovar' : 'Novo'} Funcionário</h2>
                        <form onSubmit={e=>{e.preventDefault(); onSave(d);}}>
                            <Input label="Nome" value={d.nome} onChange={e=>setD({...d, nome:e.target.value})} required />
                            <Input label="Email" value={d.email} onChange={e=>setD({...d, email:e.target.value})} required disabled={!!initialData} />
                            {!initialData && <Input label="Senha" type="password" value={d.password} onChange={e=>setD({...d, password:e.target.value})} required />}
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500">Cargo</label><select className="w-full border rounded p-2" value={d.cargoId} onChange={e=>setD({...d, cargoId:e.target.value})}><option value="">Selecione...</option>{cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500">Clientes</label><div className="flex flex-wrap gap-2 mt-1">{clientes.map(c=><span key={c.id} onClick={()=>toggle(c.id)} className={`text-xs border px-2 py-1 rounded cursor-pointer ${d.cliIds.includes(c.id)?'bg-indigo-100 border-indigo-300 text-indigo-700':''}`}>{c.nome}</span>)}</div></div>
                            <label className="flex items-center gap-2 mb-6 text-sm"><input type="checkbox" checked={d.isAdmin} onChange={e=>setD({...d, isAdmin:e.target.checked})} /> Acesso Admin</label>
                            <div className="flex justify-end gap-2"><Button type="secondary" onClick={onClose}>Cancelar</Button><Button>Salvar & Aprovar</Button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const AccessDenied = ({ onBack }) => (
            <div className="flex h-screen flex-col items-center justify-center bg-red-50 text-center p-6">
                <div className="bg-red-100 p-4 rounded-full mb-4"><AlertTriangle className="w-12 h-12 text-red-600"/></div>
                <h1 className="text-2xl font-bold text-red-700 mb-2">Acesso Negado</h1>
                <p className="text-gray-600 mb-6">Esta conta não tem permissão de administrador.</p>
                <Button onClick={onBack} type="danger">Voltar</Button>
            </div>
        );

        // NOVA TELA: Aguardando Aprovação
        const PendingApprovalView = ({ onLogout }) => (
            <div className="flex h-screen flex-col items-center justify-center bg-yellow-50 text-center p-6">
                <div className="bg-yellow-100 p-4 rounded-full mb-4"><Clock className="w-12 h-12 text-yellow-600"/></div>
                <h1 className="text-2xl font-bold text-yellow-800 mb-2">Cadastro em Análise</h1>
                <p className="text-gray-600 mb-6 max-w-md">Seu cadastro foi realizado com sucesso. Aguarde um administrador aprovar seu acesso e atribuir seu cargo e clientes.</p>
                <Button onClick={onLogout} type="secondary">Sair</Button>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [targetRole, setTargetRole] = useState(null);
            const [month, setMonth] = useState(new Date().toISOString().slice(0,7));

            // Dados
            const [cargos, setCargos] = useState([]);
            const [atividades, setAtividades] = useState([]);
            const [funcs, setFuncs] = useState([]);
            const [lancs, setLancs] = useState([]);
            const [clis, setClis] = useState([]);
            const [flags, setFlags] = useState([]);

            useEffect(() => onAuthStateChanged(auth, u => {
                setUser(u); 
                if(!u) { setProfile(null); setTargetRole(null); setLoading(false); }
            }), []);

            useEffect(() => {
                if(user) {
                    const unsubP = onSnapshot(doc(db, getPublicCollectionPath('funcionarios'), user.uid), d => {
                        if(d.exists()) {
                            const data = d.data();
                            // CHECK DE SEGURANÇA: SE FOR O EMAIL DO SUPER ADMIN, FORÇA ISADMIN = TRUE
                            if(SUPER_ADMINS.includes(data.email)) {
                                data.isAdmin = true;
                                data.approved = true;
                            }
                            setProfile(data);
                        } else {
                            setProfile({ id: user.uid, nome: user.email || 'Usuário', email: user.email || '', isAdmin: false, approved: false });
                        }
                        setLoading(false);
                    });
                    
                    const q = (n) => query(collection(db, getPublicCollectionPath(n)));
                    const uC = onSnapshot(q('cargos'), s => setCargos(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uA = onSnapshot(q('atividadesBase'), s => setAtividades(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uF = onSnapshot(q('funcionarios'), s => setFuncs(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uL = onSnapshot(q('lancamentos'), s => setLancs(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uCl = onSnapshot(q('clientes'), s => setClis(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uFl = onSnapshot(q('bandeiras'), s => setFlags(s.docs.map(d=>({id:d.id,...d.data()}))));
                    return () => { unsubP(); uC(); uA(); uF(); uL(); uCl(); uFl(); };
                }
            }, [user]);

            const filteredLancs = useMemo(() => lancs.filter(l => !l.dataConclusao || l.dataConclusao.startsWith(month)), [lancs, month]);
            const filteredFlags = useMemo(() => flags.filter(f => !f.data || f.data.startsWith(month)), [flags, month]);

            const handleRoleSelect = async (role) => {
                setTargetRole(role); 
                setLoading(false); 
            };

            const handleLogout = () => { signOut(auth); setTargetRole(null); };

            if(loading) return <div className="flex h-screen items-center justify-center font-bold text-indigo-600 animate-pulse">Carregando...</div>;
            
            if(!user) return <LoginScreen onRoleSelect={handleRoleSelect} />;

            // Roteamento
            if(targetRole === 'admin') {
                if(profile && !profile.isAdmin) return <AccessDenied onBack={handleLogout} />;
                return <AdminView db={db} userId={user.uid} cargos={cargos} funcionarios={funcs} atividades={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} logout={handleLogout} month={month} setMonth={setMonth} />;
            }

            // VERIFICAÇÃO DE APROVAÇÃO (Para Funcionários)
            if (profile && !profile.approved && !profile.isAdmin) {
                return <PendingApprovalView onLogout={handleLogout} />;
            }

            return <EmployeeView db={db} userId={user.uid} user={profile} cargos={cargos} atividades={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} logout={handleLogout} month={month} setMonth={setMonth} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Pautas</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .crown-icon { filter: drop-shadow(0px 2px 4px rgba(234, 179, 8, 0.5)); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged, signInAnonymously, setPersistence, inMemoryPersistence
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, addDoc, getDoc, 
            query, onSnapshot, where, serverTimestamp, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { 
            Settings, Users, Briefcase, ListTodo, ClipboardList, BarChart3, User, LogOut, 
            ArrowLeft, Plus, Check, Building, Trash2, Pencil, X, Calendar as CalendarIcon, 
            Flag, AlertTriangle, Lock, ShieldCheck, UserCircle, UserPlus, Eye, Crown, Star, Clock, UserCheck
        } from "https://esm.sh/lucide-react@0.292.0";

        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURAÇÃO ---
        const appId = 'sistema-avaliacao-pautas';
        const SUPER_ADMINS = ['sabrinacruz.mkt@gmail.com'];
        
        const firebaseConfig = {
            apiKey: "AIzaSyBCDi_zta4H3-WARJnOtmWneWe-9yGYJ2U",
            authDomain: "agmm-gamificacao.firebaseapp.com",
            projectId: "agmm-gamificacao",
            storageBucket: "agmm-gamificacao.firebasestorage.app",
            messagingSenderId: "833753514640",
            appId: "1:833753514640:web:70b570fd73f470d3468e15",
            measurementId: "G-Y8LCBFR78Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
        const secondaryAuth = getAuth(secondaryApp);

        const getPublicCollectionPath = (name) => `artifacts/${appId}/public/data/${name}`;
        const formatDate = (d) => {
            if(!d) return 'N/A';
            if(d.toDate) return d.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric'});
            try { const [y,m,d] = d.split('-'); return `${d}/${m}/${y}`; } catch { return 'N/A'; }
        };

        // --- COMPONENTES UI ---
        const Card = ({ children, title, icon: Icon, className = "" }) => (
            <div className={`bg-white p-6 rounded-xl shadow-sm border border-gray-200 ${className}`}>
                {title && <h2 className="flex items-center text-lg font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2">{Icon && <Icon className="w-5 h-5 mr-2 text-indigo-600" />}{title}</h2>}
                {children}
            </div>
        );

        const Button = ({ children, onClick, disabled, icon: Icon, type = "primary", size = "md", className = "" }) => {
            let base = "flex items-center justify-center font-medium rounded-lg transition-all duration-200 disabled:opacity-50 ";
            if (size === 'sm') base += "px-3 py-1.5 text-xs "; else if (size === 'icon') base += "p-2 "; else base += "px-4 py-2 text-sm ";
            const colors = {
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
                success: "bg-green-600 text-white hover:bg-green-700 shadow-sm",
                ghost: "text-gray-500 hover:bg-gray-100 border-transparent",
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${colors[type] || colors.primary} ${className}`}>{Icon && <Icon className={`w-4 h-4 ${children?'mr-2':''}`}/>}{children}</button>;
        };

        const Input = ({ label, type="text", value, onChange, required, className="" }) => (
            <div className="mb-4">
                {label && <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{label} {required && <span className="text-red-500">*</span>}</label>}
                <input type={type} value={value} onChange={onChange} required={required} className={`w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${className}`} />
            </div>
        );

        const MonthSelector = ({ selectedMonth, setSelectedMonth }) => (
            <div className="flex items-center space-x-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                <label htmlFor="month-select" className="text-xs font-medium text-gray-500 pl-2">Mês:</label>
                <input type="month" id="month-select" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="text-sm border-none focus:ring-0 bg-transparent text-gray-700 font-medium cursor-pointer outline-none" />
            </div>
        );

        // --- LOGIN ---
        const LoginScreen = ({ onRoleSelect }) => {
            const [step, setStep] = useState(1);
            const [role, setRole] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [name, setName] = useState('');

            const handleRoleClick = (selectedRole) => {
                setRole(selectedRole);
                onRoleSelect(selectedRole);
                setStep(2);
                setError('');
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true); 
                setError('');
                try {
                    if (isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        const isSuper = SUPER_ADMINS.includes(email);
                        await setDoc(doc(db, `artifacts/${appId}/public/data/funcionarios`, cred.user.uid), {
                            id: cred.user.uid, 
                            nome: name, 
                            email: email, 
                            isAdmin: isSuper, 
                            cargoId: '', 
                            clienteIds: [], 
                            approved: isSuper, // SUPER ADMIN nasce aprovado
                            timestamp: serverTimestamp()
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/email-already-in-use') msg = "E-mail já cadastrado.";
                    if (err.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                    if (err.code === 'auth/invalid-credential') msg = "E-mail ou senha incorretos.";
                    setError(msg);
                    setLoading(false);
                }
            };

            if(step === 1) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                    <div className="text-center mb-10"><h1 className="text-4xl font-bold text-indigo-900 mb-2 tracking-tight">Sistema de Pautas</h1><p className="text-gray-500">Selecione seu perfil de acesso</p></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl w-full mb-8">
                        <div onClick={()=>handleRoleClick('admin')} className="bg-white p-8 rounded-2xl shadow-sm border cursor-pointer hover:border-indigo-500 transition group text-center hover:shadow-md"><div className="bg-indigo-50 p-4 rounded-full mb-4 mx-auto w-16 group-hover:bg-indigo-100 transition"><ShieldCheck className="w-8 h-8 text-indigo-600"/></div><h2 className="text-xl font-bold text-gray-800">Administrador</h2><p className="text-sm text-gray-500 mt-2">Gestão e Validação</p></div>
                        <div onClick={()=>handleRoleClick('employee')} className="bg-white p-8 rounded-2xl shadow-sm border cursor-pointer hover:border-green-500 transition group text-center hover:shadow-md"><div className="bg-green-50 p-4 rounded-full mb-4 mx-auto w-16 group-hover:bg-green-100 transition"><UserCircle className="w-8 h-8 text-green-600"/></div><h2 className="text-xl font-bold text-gray-800">Funcionário</h2><p className="text-sm text-gray-500 mt-2">Produção e Lançamentos</p></div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <Card className="w-full max-w-md relative border-0 shadow-xl">
                        <button onClick={()=>{setStep(1); setIsRegistering(false); setError('')}} className="absolute top-6 left-6 text-gray-400 hover:text-gray-600 flex items-center text-xs uppercase font-bold"><ArrowLeft className="w-3 h-3 mr-1"/> Voltar</button>
                        <div className="text-center mb-8 mt-4"><h1 className="text-2xl font-bold text-gray-800">Login {role === 'admin' ? 'Admin' : ''}</h1><p className="text-gray-500 text-sm">Insira suas credenciais</p></div>
                        <form onSubmit={handleAuth}>
                            {isRegistering && <Input label="Nome" value={name} onChange={e=>setName(e.target.value)} required />}
                            <Input label="E-mail" type="email" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <Input label="Senha" type="password" value={password} onChange={e=>setPassword(e.target.value)} required />
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center border border-red-100">{error}</div>}
                            <Button className="w-full h-10" disabled={loading}>{loading ? 'Processando...' : (isRegistering ? 'Criar Conta' : 'Entrar')}</Button>
                        </form>
                        <div className="text-center mt-4 pt-4 border-t border-gray-100">
                            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-xs text-gray-500 hover:text-indigo-600 font-medium">{isRegistering ? 'Já possui conta? Faça Login' : 'Não tem acesso? Cadastre-se aqui'}</button>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- ADMIN COMPONENTS ---
        const RankingChart = ({ data }) => {
            const maxScore = Math.max(...data.map(f => f.score || 0), 1); 
            return (
                <div className="space-y-4">
                    {data.map((f, index) => {
                        const isFirst = index === 0;
                        return (
                            <div key={f.id} className={`relative p-3 rounded-xl border transition-all ${isFirst ? 'bg-yellow-50 border-yellow-200 shadow-sm' : 'bg-white border-gray-100 hover:shadow-sm'}`}>
                                <div className="flex justify-between items-center mb-2 z-10 relative">
                                    <div className="flex items-center gap-2">
                                        {isFirst ? <div className="w-6 h-6 flex items-center justify-center bg-yellow-100 rounded-full text-yellow-600 crown-icon"><Crown className="w-4 h-4 fill-current" /></div> : <div className="w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 text-xs font-bold">{index + 1}</div>}
                                        <span className={`font-semibold ${isFirst ? 'text-yellow-800' : 'text-gray-700'}`}>{f.nome}</span>
                                    </div>
                                    <span className={`font-bold text-sm ${isFirst ? 'text-yellow-700' : 'text-indigo-600'}`}>{f.score}%</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div className={`h-full rounded-full transition-all duration-500 ${isFirst ? 'bg-yellow-400' : 'bg-indigo-500'}`} style={{ width: f.score > 0 ? `${f.score}%` : '2%' }}></div></div>
                                {f.totalPenalidades > 0 && <div className="mt-1 flex justify-end"><span className="text-[10px] text-red-500 bg-red-50 px-1.5 py-0.5 rounded flex items-center"><Flag className="w-3 h-3 mr-1" /> -{f.totalPenalidades} pts</span></div>}
                            </div>
                        );
                    })}
                    {data.length === 0 && <p className="text-center text-gray-400 text-sm py-4">Sem dados de ranking.</p>}
                </div>
            );
        };

        const CalendarView = ({ db, userId, funcionarios, lancamentos, bandeiras, selectedMonth }) => {
            const [selectedFuncionarioId, setSelectedFuncionarioId] = useState('');
            const [flagModalOpen, setFlagModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [flagReason, setFlagReason] = useState('');
            const [loadingFlag, setLoadingFlag] = useState(false);

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
            const year = parseInt(selectedMonth.split('-')[0]);
            const month = parseInt(selectedMonth.split('-')[1]) - 1;
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const blanksArray = Array.from({ length: firstDay }, (_, i) => i);

            const funcionarioLancamentos = useMemo(() => selectedFuncionarioId ? lancamentos.filter(l => l.funcionarioId === selectedFuncionarioId) : [], [lancamentos, selectedFuncionarioId]);
            const funcionarioBandeiras = useMemo(() => selectedFuncionarioId ? bandeiras.filter(b => b.funcionarioId === selectedFuncionarioId) : [], [bandeiras, selectedFuncionarioId]);

            const handleDayClick = (day) => {
                if (!selectedFuncionarioId) return;
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const existingFlag = funcionarioBandeiras.find(b => b.data === dateStr);
                if (existingFlag) {
                    if (window.confirm("Remover bandeira?")) deleteDoc(doc(db, getPublicCollectionPath('bandeiras'), existingFlag.id));
                } else {
                    setSelectedDate(dateStr);
                    setFlagModalOpen(true);
                }
            };

            const handleAddFlag = async () => {
                if (!db || !selectedFuncionarioId || !selectedDate) return;
                setLoadingFlag(true);
                try {
                    await addDoc(collection(db, getPublicCollectionPath('bandeiras')), {
                        funcionarioId: selectedFuncionarioId, data: selectedDate, motivo: flagReason || 'Penalidade Administrativa', criadoPor: userId, timestamp: serverTimestamp()
                    });
                    setFlagModalOpen(false); setFlagReason('');
                } catch (error) { console.error("Erro:", error); } finally { setLoadingFlag(false); }
            };

            return (
                <div className="space-y-6">
                    <Card title="Calendário e Penalidades" icon={CalendarIcon}>
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-600 mb-2">Selecione o Funcionário</label>
                            <select value={selectedFuncionarioId} onChange={(e) => setSelectedFuncionarioId(e.target.value)} className="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Selecione --</option>
                                {funcionarios.map(f => <option key={f.id} value={f.id}>{f.nome}</option>)}
                            </select>
                        </div>
                        {selectedFuncionarioId && (
                            <div className="border rounded-lg overflow-hidden bg-white shadow-sm">
                                <div className="grid grid-cols-7 bg-gray-50 border-b text-center py-2 text-xs font-semibold text-gray-500 uppercase">{['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => <div key={d}>{d}</div>)}</div>
                                <div className="grid grid-cols-7 bg-white">
                                    {blanksArray.map(b => <div key={`blank-${b}`} className="h-20 border-b border-r bg-gray-50/30"></div>)}
                                    {daysArray.map(day => {
                                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                        const hasLancamento = funcionarioLancamentos.some(l => l.dataConclusao === dateStr);
                                        const hasFlag = funcionarioBandeiras.find(b => b.data === dateStr);
                                        return (
                                            <div key={day} onClick={() => handleDayClick(day)} className="h-20 border-b border-r p-1 cursor-pointer hover:bg-indigo-50 group">
                                                <span className={`text-sm font-medium ${hasFlag ? 'text-red-600' : 'text-gray-700'}`}>{day}</span>
                                                <div className="flex flex-col gap-1 mt-1">
                                                    {hasLancamento && <div className="flex items-center text-[10px] text-green-700 bg-green-50 border border-green-100 px-1 rounded"><Check className="w-3 h-3 mr-1" /> Entregue</div>}
                                                    {hasFlag && <div className="flex items-center text-[10px] text-red-700 bg-red-50 border border-red-100 px-1 rounded"><Flag className="w-3 h-3 mr-1" /> Penalidade</div>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </Card>
                    {flagModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
                                <h3 className="text-lg font-bold text-red-600 mb-4 flex items-center"><AlertTriangle className="w-5 h-5 mr-2"/> Penalidade</h3>
                                <Input label="Motivo da Bandeira" value={flagReason} onChange={(e) => setFlagReason(e.target.value)} />
                                <div className="flex justify-end space-x-2 mt-4">
                                    <Button type="secondary" onClick={() => setFlagModalOpen(false)}>Cancelar</Button>
                                    <Button type="danger" onClick={handleAddFlag} disabled={loadingFlag}>Aplicar (-1 pt)</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- VALIDAÇÃO DE LANÇAMENTO ---
        const ValidacaoLancamento = ({ db, userId, lancamentos, atividadesBase, funcionarios }) => {
            const pendentes = useMemo(() => lancamentos.filter(l => l.status === 'Pendente'), [lancamentos]);
            const [scoreMap, setScoreMap] = useState({});
            const [loadingMap, setLoadingMap] = useState({});

            useEffect(() => {
                const map = {};
                pendentes.forEach(l => { 
                    if (scoreMap[l.id] === undefined) {
                        const max = atividadesBase.find(a => a.id === l.atividadeBaseId)?.pontuacaoMaxima || 1;
                        map[l.id] = max; 
                    }
                });
                if (Object.keys(map).length > 0) {
                    setScoreMap(prev => ({ ...prev, ...map }));
                }
            }, [pendentes, atividadesBase]); 

            const handleVal = async (l) => {
                setLoadingMap(p => ({...p, [l.id]: true}));
                try {
                    await setDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id), { 
                        status: 'Validado', 
                        pontuacaoAtribuida: Number(scoreMap[l.id]), 
                        dataValidacao: serverTimestamp(), 
                        validadorId: userId 
                    }, {merge:true});
                } catch(e){ console.error(e); } finally { setLoadingMap(p => ({...p, [l.id]: false})); }
            };

            if (pendentes.length === 0) return <div className="text-center p-8 bg-white rounded-xl border border-gray-200 text-gray-500">Tudo limpo! Nenhum lançamento pendente.</div>;

            return (
                <div className="space-y-3">
                    {pendentes.map(l => {
                        const atv = atividadesBase.find(a => a.id === l.atividadeBaseId) || {};
                        const func = funcionarios.find(f => f.id === l.funcionarioId) || {};
                        const maxScore = Number(atv.pontuacaoMaxima) || 1;
                        
                        return (
                            <div key={l.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex-1">
                                    <p className="font-bold text-indigo-700 text-base">{atv.nome}</p>
                                    <p className="text-sm text-gray-600 mt-1">Funcionário: <span className="font-semibold">{func.nome}</span></p>
                                    <div className="flex items-center gap-3 mt-1 text-xs text-gray-400">
                                        <span className="flex items-center"><CalendarIcon className="w-3 h-3 mr-1"/> {formatDate(l.dataConclusao)}</span>
                                        {l.descricao && <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[200px]">{l.descricao}</span>}
                                    </div>
                                </div>
                                <div className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg">
                                    <span className="text-xs text-gray-500 font-bold uppercase mr-1">Nota:</span>
                                    <input 
                                        type="number" 
                                        max={maxScore} 
                                        min="0"
                                        value={scoreMap[l.id] !== undefined ? scoreMap[l.id] : maxScore} 
                                        onChange={e => setScoreMap(p => ({...p, [l.id]: e.target.value}))} 
                                        className="w-12 text-center border rounded py-1 text-sm font-bold text-indigo-700 focus:ring-indigo-500 outline-none"
                                    />
                                    <span className="text-xs text-gray-400">/ {maxScore}</span>
                                    <Button size="sm" onClick={()=>handleVal(l)} disabled={loadingMap[l.id]} icon={Check}>Validar</Button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- ATIVIDADES BASE FORM ---
        const AtividadeBaseForm = ({ db, userId, cargos, atividadesBase }) => {
            const [nome, setNome] = useState(''); 
            const [cargoId, setCargoId] = useState(''); 
            const [peso, setPeso] = useState('');
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!nome || !cargoId || !peso) return;
                const data = { 
                    nome, 
                    cargoId, 
                    pontuacaoMaxima: Number(peso), 
                    criadoPor: userId,
                    timestamp: serverTimestamp()
                };
                try {
                    if(editingId) await setDoc(doc(db, getPublicCollectionPath('atividadesBase'), editingId), data, {merge:true});
                    else await addDoc(collection(db, getPublicCollectionPath('atividadesBase')), data);
                    setNome(''); setCargoId(''); setPeso(''); setEditingId(null);
                } catch(e){ console.error(e); }
            };

            const handleEdit = (item) => {
                setNome(item.nome); setCargoId(item.cargoId); setPeso(item.pontuacaoMaxima); setEditingId(item.id);
            };

            const handleDelete = async (id) => {
                if(confirm('Excluir atividade?')) deleteDoc(doc(db, getPublicCollectionPath('atividadesBase'), id));
            };

            return (
                <Card title="Atividades Base" icon={ListTodo}>
                    <form onSubmit={handleSubmit} className="mb-6 space-y-3 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <Input label="Nome da Atividade" value={nome} onChange={e=>setNome(e.target.value)} placeholder="Ex: Criar Post" required className="bg-white"/>
                        <div className="flex gap-2">
                            <div className="w-2/3">
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Cargo</label>
                                <select value={cargoId} onChange={e=>setCargoId(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Selecione...</option>
                                    {cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                </select>
                            </div>
                            <div className="w-1/3">
                                <Input type="number" label="Pontuação" value={peso} onChange={e=>setPeso(e.target.value)} placeholder="Pts" required className="bg-white" />
                            </div>
                        </div>
                        <div className="flex justify-end gap-2">
                            {editingId && <Button type="secondary" size="sm" onClick={() => { setEditingId(null); setNome(''); setCargoId(''); setPeso(''); }}>Cancelar</Button>}
                            <Button size="sm">{editingId ? 'Salvar' : 'Adicionar'}</Button>
                        </div>
                    </form>
                    <ul className="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                        {atividadesBase.map(a => (
                            <li key={a.id} className="flex justify-between items-center p-2 bg-white border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors group">
                                <div>
                                    <span className="text-sm font-medium text-gray-700 block">{a.nome}</span>
                                    <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">Valendo: {a.pontuacaoMaxima} pts</span>
                                </div>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Button type="ghost" size="icon" onClick={()=>handleEdit(a)}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                    <Button type="ghost" size="icon" onClick={()=>handleDelete(a.id)}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                </div>
                            </li>
                        ))}
                    </ul>
                </Card>
            );
        };

        const AdminView = ({ db, userId, cargos, funcionarios, atividades, lancamentos, clientes, bandeiras, logout, month, setMonth }) => {
            const [tab, setTab] = useState('dashboard');
            const [showUserModal, setShowUserModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            
            const dashData = useMemo(() => {
                const d = funcionarios.map(f => ({ ...f, pts: 0, max: 0, count: 0, flags: 0, score: 0 }));
                lancamentos.filter(l=>l.status==='Validado').forEach(l => {
                    const idx = d.findIndex(x=>x.id===l.funcionarioId);
                    if(idx > -1) {
                        const atv = atividades.find(a=>a.id===l.atividadeBaseId);
                        d[idx].pts += Number(l.pontuacaoAtribuida||0);
                        d[idx].max += (atv?.pontuacaoMaxima||1);
                        d[idx].count++;
                    }
                });
                bandeiras.forEach(b => {
                    const idx = d.findIndex(x=>x.id===b.funcionarioId);
                    if(idx > -1) { d[idx].flags++; d[idx].pts -= 1; }
                });
                return d.map(x => ({ ...x, pts: Math.max(0, x.pts), score: x.max > 0 ? ((Math.max(0, x.pts)/x.max)*100).toFixed(0) : 0 })).sort((a,b)=>b.score-a.score);
            }, [funcionarios, lancamentos, bandeiras, atividades]);

            const handleCreateOrUpdateUser = async (data) => {
                try {
                    // IMPORTANTE: Configura persistência da App secundária para não afetar o login atual
                    await setPersistence(secondaryAuth, inMemoryPersistence);

                    if (data.id) {
                        await setDoc(doc(db, getPublicCollectionPath('funcionarios'), data.id), {
                            nome: data.nome, cargoId: data.cargoId, clienteIds: data.cliIds, isAdmin: data.isAdmin, approved: true // Ao editar, aprova automaticamente
                        }, { merge: true });
                        alert("Usuário atualizado e aprovado!");
                    } else {
                        const cred = await createUserWithEmailAndPassword(secondaryAuth, data.email, data.password);
                        await setDoc(doc(db, getPublicCollectionPath('funcionarios'), cred.user.uid), {
                            id: cred.user.uid, nome: data.nome, email: data.email, cargoId: data.cargoId, clienteIds: data.cliIds, isAdmin: data.isAdmin, approved: true, criadoPor: userId, timestamp: serverTimestamp()
                        });
                        await signOut(secondaryAuth);
                        alert("Usuário criado com sucesso!");
                    }
                    setShowUserModal(false);
                    setEditingUser(null);
                } catch(e) { 
                    let msg = e.message;
                    if (e.code === 'auth/email-already-in-use') msg = "Este e-mail já está em uso.";
                    alert("Erro: " + msg); 
                }
            };

            const handleAdd = async (col, data) => addDoc(collection(db, getPublicCollectionPath(col)), { ...data, criadoPor: userId, timestamp: serverTimestamp() });
            const handleEdit = async (col, id, data) => setDoc(doc(db, getPublicCollectionPath(col), id), data, { merge: true });
            const handleDel = async (col, id) => { if(confirm('Excluir?')) deleteDoc(doc(db, getPublicCollectionPath(col), id)); };
            const handleVal = async (l, score) => setDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id), { status: 'Validado', pontuacaoAtribuida: score, validadorId: userId }, {merge:true});

            // Filtra usuários pendentes
            const pendingUsers = useMemo(() => funcionarios.filter(f => !f.approved && !f.isAdmin), [funcionarios]);

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b"><h1 className="text-3xl font-bold text-gray-800 flex items-center"><Settings className="mr-3 text-indigo-600"/> Admin</h1><div className="flex gap-4"><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border rounded p-2"/><Button onClick={logout} type="secondary" icon={LogOut}>Sair</Button></div></header>
                    <div className="flex gap-2 mb-8 overflow-x-auto pb-2">{[{id:'dashboard',label:'Dashboard',icon:BarChart3}, {id:'calendario',label:'Calendário',icon:CalendarIcon}, {id:'validacao',label:'Validação',icon:ClipboardList},{id:'cadastros',label:'Cadastros',icon:Briefcase}].map(t=><button key={t.id} onClick={()=>setTab(t.id)} className={`px-5 py-2 rounded-full text-sm flex items-center ${tab===t.id?'bg-indigo-600 text-white':'bg-white border'}`}><t.icon className="w-4 h-4 mr-2"/>{t.label}</button>)}</div>
                    
                    {tab==='dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card title="Ranking de Desempenho" className="md:col-span-1 h-full"><RankingChart data={dashData} /></Card>
                            <Card title="Detalhes Individuais" className="md:col-span-2"><div className="space-y-3 max-h-[60vh] overflow-y-auto">{dashData.map(f=><div key={f.id} className="p-4 border rounded bg-white hover:bg-gray-50 transition"><div className="flex justify-between font-bold mb-2"><span>{f.nome}</span><span className={f.score >= 90 ? "text-green-600" : "text-gray-600"}>{f.score}%</span></div><div className="text-sm text-gray-600 flex justify-between"><span>Pontos: {f.pts}/{f.max}</span>{f.flags>0 && <span className="text-red-600 font-semibold flex items-center"><Flag className="w-3 h-3 mr-1"/>{f.flags} Penalidade(s)</span>}</div></div>)}</div></Card>
                        </div>
                    )}

                    {tab==='calendario' && <CalendarView db={db} userId={userId} funcionarios={funcionarios} lancamentos={lancamentos} bandeiras={bandeiras} selectedMonth={month} />}

                    {tab==='validacao' && (
                        <Card title="Pendentes" icon={ClipboardList}>
                            <div className="space-y-4">
                                {lancamentos.filter(l=>l.status==='Pendente').map(l => {
                                    const atv = atividades.find(a=>a.id===l.atividadeBaseId);
                                    const func = funcionarios.find(f=>f.id===l.funcionarioId);
                                    return <div key={l.id} className="flex justify-between items-center p-3 border rounded"><div><p className="font-bold">{atv?.nome}</p><p className="text-sm">{func?.nome} - {formatDate(l.dataConclusao)}</p></div><div className="flex gap-2"><Button size="sm" onClick={()=>handleVal(l, atv?.pontuacaoMaxima)} icon={Check}>Validar (Max)</Button></div></div>
                                })}
                                {lancamentos.filter(l=>l.status==='Pendente').length === 0 && <p className="text-center text-gray-500">Nada pendente.</p>}
                            </div>
                        </Card>
                    )}

                    {tab==='cadastros' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* ÁREA DE APROVAÇÃO DE PENDENTES */}
                            {pendingUsers.length > 0 && (
                                <div className="col-span-1 md:col-span-2">
                                    <Card title="Solicitações de Acesso" icon={UserPlus} className="bg-yellow-50 border-yellow-200">
                                        <div className="space-y-2">
                                            {pendingUsers.map(f => (
                                                <div key={f.id} className="flex justify-between items-center p-3 bg-white rounded border border-yellow-200">
                                                    <div>
                                                        <span className="font-bold text-gray-800">{f.nome}</span>
                                                        <span className="text-sm text-gray-500 ml-2">({f.email})</span>
                                                        <span className="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold">Novo</span>
                                                    </div>
                                                    <Button size="sm" type="success" icon={Check} onClick={()=>{setEditingUser(f); setShowUserModal(true);}}>Aprovar e Configurar</Button>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </div>
                            )}

                            <SimpleForm title="Cargos" onAdd={n=>handleAdd('cargos',{nome:n})} onEdit={(id,n)=>handleEdit('cargos',id,{nome:n})} list={cargos} onDel={id=>handleDel('cargos',id)} />
                            <AtividadeBaseForm db={db} userId={userId} cargos={cargos} atividadesBase={atividades} />
                            <SimpleForm title="Clientes" onAdd={n=>handleAdd('clientes',{nome:n})} onEdit={(id,n)=>handleEdit('clientes',id,{nome:n})} list={clientes} onDel={id=>handleDel('clientes',id)} />
                            
                            <Card title="Funcionários Ativos" icon={Users}>
                                <div className="flex justify-between items-center mb-4"><span className="text-sm text-gray-500">Total: {funcionarios.length}</span><Button size="sm" icon={UserPlus} onClick={()=>{setEditingUser(null); setShowUserModal(true);}}>Novo</Button></div>
                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {funcionarios.map(f=>(
                                        <div key={f.id} className={`flex justify-between p-3 border rounded items-center text-sm bg-white ${!f.approved && !f.isAdmin ? 'border-l-4 border-l-yellow-400' : ''}`}>
                                            <div>
                                                <p className="font-semibold flex items-center">
                                                    {f.nome} 
                                                    {!f.approved && !f.isAdmin && <span className="ml-2 text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold">Pendente</span>}
                                                </p>
                                                <p className="text-xs text-gray-500">{f.email}</p>
                                            </div>
                                            <div className="flex gap-1">
                                                <Button size="icon" type="ghost" onClick={()=>{setEditingUser(f); setShowUserModal(true);}}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                                <Button size="icon" type="ghost" onClick={()=>handleDel('funcionarios', f.id)}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    )}
                    {showUserModal && <CreateUserModal onClose={()=>setShowUserModal(false)} onSave={handleCreateOrUpdateUser} cargos={cargos} clientes={clientes} initialData={editingUser} />}
                </div>
            );
        };

        const EmployeeView = ({ db, userId, user, cargos, atividades, lancamentos, clientes, bandeiras, logout, month, setMonth }) => {
            const [form, setForm] = useState({ atvId: '', cliId: '', date: '', desc: '' });
            const cargo = cargos.find(c=>c.id===user.cargoId);
            const myLancs = lancamentos.filter(l=>l.funcionarioId===userId);
            const myFlags = bandeiras.filter(b=>b.funcionarioId===userId);
            const myAtvs = atividades.filter(a=>a.cargoId===user.cargoId);
            const myClis = clientes.filter(c=>(user.clienteIds||[]).includes(c.id));

            const totalScore = useMemo(() => {
                const points = myLancs.filter(l => l.status === 'Validado').reduce((acc, curr) => acc + Number(curr.pontuacaoAtribuida || 0), 0);
                const penaltyPoints = myFlags.length;
                return Math.max(0, points - penaltyPoints);
            }, [myLancs, myFlags]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, getPublicCollectionPath('lancamentos')), {
                    funcionarioId: userId, atividadeBaseId: form.atvId, clienteId: form.cliId, dataConclusao: form.date, descricao: form.desc,
                    status: 'Pendente', pontuacaoAtribuida: 0, dataLancamento: serverTimestamp()
                });
                setForm({ atvId: '', cliId: '', date: '', desc: '' }); alert("Enviado!");
            };

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b"><h1 className="text-2xl font-bold text-indigo-800 flex items-center"><User className="mr-2"/> {user.nome}</h1><div className="flex gap-4"><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border rounded p-2"/><Button onClick={logout} type="secondary" icon={LogOut}>Sair</Button></div></header>
                    <div className="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <Card className="bg-indigo-50 border-indigo-100"><div className="flex justify-between items-center"><div><p className="text-sm font-bold text-gray-500 uppercase">Cargo</p><p className="text-xl text-indigo-700">{cargo?.nome || '-'}</p></div>{myFlags.length > 0 && <div className="bg-red-100 text-red-700 px-4 py-2 rounded border border-red-200 flex items-center"><AlertTriangle className="w-5 h-5 mr-2"/>{myFlags.length} Penalidades</div>}</div></Card>
                        <Card className="bg-green-50 border-green-100"><div className="flex items-center justify-between"><div><p className="text-sm font-bold text-gray-500 uppercase">Pontuação Acumulada</p><p className="text-3xl font-extrabold text-green-700">{totalScore} pts</p></div><div className="bg-green-200 p-3 rounded-full text-green-800"><Star className="w-8 h-8 fill-current" /></div></div></Card>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <Card title="Novo Lançamento" icon={Plus}>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-500">Cliente</label><select className="w-full border rounded p-2" value={form.cliId} onChange={e=>setForm({...form, cliId:e.target.value})}><option value="">Selecione...</option>{myClis.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">Atividade</label>
                                    <select className="w-full border rounded p-2" value={form.atvId} onChange={e=>setForm({...form, atvId:e.target.value})} required>
                                        <option value="">Selecione...</option>
                                        {/* MOSTRA APENAS O NOME, SEM PONTOS */}
                                        {myAtvs.map(a=><option key={a.id} value={a.id}>{a.nome}</option>)}
                                    </select>
                                </div>
                                <Input label="Data" type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required />
                                <Button className="w-full">Lançar</Button>
                            </form>
                        </Card>
                        <Card title="Histórico" icon={ClipboardList} className="md:col-span-2">
                            <div className="space-y-2 max-h-80 overflow-y-auto">{myLancs.map(l=><div key={l.id} className="p-3 border rounded bg-white flex justify-between items-center"><span>{atividades.find(a=>a.id===l.atividadeBaseId)?.nome} <span className="text-xs text-gray-400 ml-2">{formatDate(l.dataConclusao)}</span></span><span className={`text-xs px-2 py-1 rounded ${l.status==='Validado'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>{l.status}</span></div>)}</div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- HELPERS ---
        const SimpleForm = ({ title, list, onAdd, onEdit, onDel, extraFields, cargos }) => {
            const [val, setVal] = useState(''); const [cid, setCid] = useState(''); const [editingId, setEditingId] = useState(null);
            
            const handleSubmit = () => {
                if(val.trim()){
                    if(editingId) onEdit(editingId, val);
                    else onAdd(val);
                    setVal(''); setEditingId(null);
                }
            };

            return (
                <Card title={title} icon={ListTodo}>
                    <div className="flex gap-2 mb-4">
                        <Input value={val} onChange={e=>setVal(e.target.value)} placeholder={editingId ? "Editando..." : "Nome"} className="mb-0 flex-1"/>
                        {extraFields && <select className="border rounded px-2 w-1/3" value={cid} onChange={e=>setCid(e.target.value)}><option value="">Cargo</option>{cargos?.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select>}
                        <Button size="sm" onClick={handleSubmit}>{editingId ? 'Salvar' : '+'}</Button>
                        {editingId && <Button size="icon" type="ghost" onClick={()=>{setEditingId(null); setVal('')}}><X className="w-4 h-4"/></Button>}
                    </div>
                    <div className="space-y-1 max-h-40 overflow-y-auto">{list.map(i=><div key={i.id} className="flex justify-between p-2 border rounded text-sm bg-gray-50"><span>{i.nome}</span><div className="flex gap-1"><button onClick={()=>{setEditingId(i.id); setVal(i.nome);}} className="text-blue-600"><Pencil className="w-3 h-3"/></button><button onClick={()=>onDel(i.id)} className="text-red-500"><Trash2 className="w-3 h-3"/></button></div></div>)}</div>
                </Card>
            );
        };

        const CreateUserModal = ({ onClose, onSave, cargos, clientes, initialData }) => {
            const [d, setD] = useState(initialData ? 
                { id: initialData.id, nome: initialData.nome, email: initialData.email, cargoId: initialData.cargoId, cliIds: initialData.clienteIds || [], isAdmin: initialData.isAdmin } 
                : { nome:'', email:'', password:'', cargoId:'', cliIds:[], isAdmin: false }
            );
            
            const toggle = (id) => setD(p => ({...p, cliIds: p.cliIds.includes(id)?p.cliIds.filter(x=>x!==id):[...p.cliIds, id]}));
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-xl max-h-[90vh] overflow-y-auto">
                        <h2 className="text-lg font-bold mb-4">{initialData ? 'Editar & Aprovar' : 'Novo'} Funcionário</h2>
                        <form onSubmit={e=>{e.preventDefault(); onSave(d);}}>
                            <Input label="Nome" value={d.nome} onChange={e=>setD({...d, nome:e.target.value})} required />
                            <Input label="Email" value={d.email} onChange={e=>setD({...d, email:e.target.value})} required disabled={!!initialData} />
                            {!initialData && <Input label="Senha" type="password" value={d.password} onChange={e=>setD({...d, password:e.target.value})} required />}
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500">Cargo</label><select className="w-full border rounded p-2" value={d.cargoId} onChange={e=>setD({...d, cargoId:e.target.value})}><option value="">Selecione...</option>{cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500">Clientes</label><div className="flex flex-wrap gap-2 mt-1">{clientes.map(c=><span key={c.id} onClick={()=>toggle(c.id)} className={`text-xs border px-2 py-1 rounded cursor-pointer ${d.cliIds.includes(c.id)?'bg-indigo-100 border-indigo-300 text-indigo-700':''}`}>{c.nome}</span>)}</div></div>
                            <label className="flex items-center gap-2 mb-6 text-sm"><input type="checkbox" checked={d.isAdmin} onChange={e=>setD({...d, isAdmin:e.target.checked})} /> Acesso Admin</label>
                            <div className="flex justify-end gap-2"><Button type="secondary" onClick={onClose}>Cancelar</Button><Button>Salvar & Aprovar</Button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const AccessDenied = ({ onBack }) => (
            <div className="flex h-screen flex-col items-center justify-center bg-red-50 text-center p-6">
                <div className="bg-red-100 p-4 rounded-full mb-4"><AlertTriangle className="w-12 h-12 text-red-600"/></div>
                <h1 className="text-2xl font-bold text-red-700 mb-2">Acesso Negado</h1>
                <p className="text-gray-600 mb-6">Esta conta não tem permissão de administrador.</p>
                <Button onClick={onBack} type="danger">Voltar</Button>
            </div>
        );

        // NOVA TELA: Aguardando Aprovação
        const PendingApprovalView = ({ onLogout }) => (
            <div className="flex h-screen flex-col items-center justify-center bg-yellow-50 text-center p-6">
                <div className="bg-yellow-100 p-4 rounded-full mb-4"><Clock className="w-12 h-12 text-yellow-600"/></div>
                <h1 className="text-2xl font-bold text-yellow-800 mb-2">Cadastro em Análise</h1>
                <p className="text-gray-600 mb-6 max-w-md">Seu cadastro foi realizado com sucesso. Aguarde um administrador aprovar seu acesso e atribuir seu cargo e clientes.</p>
                <Button onClick={onLogout} type="secondary">Sair</Button>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [targetRole, setTargetRole] = useState(null);
            const [month, setMonth] = useState(new Date().toISOString().slice(0,7));

            // Dados
            const [cargos, setCargos] = useState([]);
            const [atividades, setAtividades] = useState([]);
            const [funcs, setFuncs] = useState([]);
            const [lancs, setLancs] = useState([]);
            const [clis, setClis] = useState([]);
            const [flags, setFlags] = useState([]);

            useEffect(() => onAuthStateChanged(auth, u => {
                setUser(u); 
                if(!u) { setProfile(null); setTargetRole(null); setLoading(false); }
            }), []);

            useEffect(() => {
                if(user) {
                    const unsubP = onSnapshot(doc(db, getPublicCollectionPath('funcionarios'), user.uid), d => {
                        if(d.exists()) {
                            const data = d.data();
                            // CHECK DE SEGURANÇA: SE FOR O EMAIL DO SUPER ADMIN, FORÇA ISADMIN = TRUE
                            if(SUPER_ADMINS.includes(data.email)) {
                                data.isAdmin = true;
                                data.approved = true;
                            }
                            setProfile(data);
                        } else {
                            setProfile({ id: user.uid, nome: user.email || 'Usuário', email: user.email || '', isAdmin: false, approved: false });
                        }
                        setLoading(false);
                    });
                    
                    const q = (n) => query(collection(db, getPublicCollectionPath(n)));
                    const uC = onSnapshot(q('cargos'), s => setCargos(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uA = onSnapshot(q('atividadesBase'), s => setAtividades(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uF = onSnapshot(q('funcionarios'), s => setFuncs(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uL = onSnapshot(q('lancamentos'), s => setLancs(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uCl = onSnapshot(q('clientes'), s => setClis(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uFl = onSnapshot(q('bandeiras'), s => setFlags(s.docs.map(d=>({id:d.id,...d.data()}))));
                    return () => { unsubP(); uC(); uA(); uF(); uL(); uCl(); uFl(); };
                }
            }, [user]);

            const filteredLancs = useMemo(() => lancs.filter(l => !l.dataConclusao || l.dataConclusao.startsWith(month)), [lancs, month]);
            const filteredFlags = useMemo(() => flags.filter(f => !f.data || f.data.startsWith(month)), [flags, month]);

            const handleRoleSelect = async (role) => {
                setTargetRole(role); 
                setLoading(false); 
            };

            const handleLogout = () => { signOut(auth); setTargetRole(null); };

            if(loading) return <div className="flex h-screen items-center justify-center font-bold text-indigo-600 animate-pulse">Carregando...</div>;
            
            if(!user) return <LoginScreen onRoleSelect={handleRoleSelect} />;

            // Roteamento
            if(targetRole === 'admin') {
                if(profile && !profile.isAdmin) return <AccessDenied onBack={handleLogout} />;
                return <AdminView db={db} userId={user.uid} cargos={cargos} funcionarios={funcs} atividades={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} logout={handleLogout} month={month} setMonth={setMonth} />;
            }

            // VERIFICAÇÃO DE APROVAÇÃO (Para Funcionários)
            if (profile && !profile.approved && !profile.isAdmin) {
                return <PendingApprovalView onLogout={handleLogout} />;
            }

            return <EmployeeView db={db} userId={user.uid} user={profile} cargos={cargos} atividades={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} logout={handleLogout} month={month} setMonth={setMonth} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

